<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goldeneye Admin - Multi-Key Management</title>
    <link rel="stylesheet" href="https://iaconelli.org/css/bundle.min.css">
    <script>
        // Theme toggle functionality - inlined from Hugo
        document.addEventListener("DOMContentLoaded", () => {
            initTheme();

            const themeToggle = document.getElementById("theme-toggle");
            if (themeToggle) {
                themeToggle.setAttribute("aria-pressed", "false");
                themeToggle.addEventListener("click", toggleTheme);
            }
        });

        function initTheme() {
            const savedTheme = localStorage.getItem("theme");
            const prefersDark = window.matchMedia(
                "(prefers-color-scheme: dark)",
            ).matches;

            let theme = "light";
            if (savedTheme) {
                theme = savedTheme;
            } else if (prefersDark) {
                theme = "dark";
            }

            setTheme(theme);
        }

        function toggleTheme() {
            const currentTheme =
                document.documentElement.getAttribute("data-theme") || "light";
            const newTheme = currentTheme === "dark" ? "light" : "dark";
            setTheme(newTheme);
        }

        function setTheme(theme) {
            document.documentElement.setAttribute("data-theme", theme);
            localStorage.setItem("theme", theme);

            const toggle = document.getElementById("theme-toggle");
            if (toggle) {
                toggle.setAttribute(
                    "aria-pressed",
                    theme === "dark" ? "true" : "false",
                );
                toggle.setAttribute(
                    "aria-label",
                    theme === "dark"
                        ? "Switch to light mode"
                        : "Switch to dark mode",
                );
            }
        }
    </script>
    <style>
        /* Reset any admin-specific overrides to use pure theme */
        .vault-container {
            max-width: 1060px;
            margin: 0 auto;
            padding: 0;
            background: none;
            border: none;
            border-radius: 0;
        }
        
        /* Navigation tabs with theme styling */
        .nav-tabs {
            display: flex;
            border-bottom: 1px solid var(--text-color);
            margin-bottom: 2rem;
            gap: 0;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-family: var(--font-text);
            font-size: var(--base-font-size);
            color: var(--text-color);
            transition: all 0.2s ease;
        }

        .nav-tab.active {
            border-bottom-color: var(--link-color);
            font-weight: bold;
        }

        .nav-tab:hover {
            color: var(--link-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Section styling with theme consistency */
        .section {
            margin-bottom: 3rem;
            padding: 2rem 0;
            border-bottom: 1px solid rgba(35, 35, 35, 0.1);
        }
        
        .section:last-child {
            border-bottom: none;
        }

        /* Table styling with theme fonts */
        .key-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-family: var(--font-text);
            font-size: var(--base-font-size);
        }

        .key-table th,
        .key-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(35, 35, 35, 0.1);
            vertical-align: middle;
        }

        .key-table th {
            font-family: var(--font-headline);
            font-weight: normal;
            color: var(--text-color);
            font-size: var(--heading-size);
        }

        .key-table tr:last-child td {
            border-bottom: none;
        }

        /* Form styling with theme consistency */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-family: var(--font-headline);
            font-size: var(--heading-size);
            color: var(--text-color);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            max-width: 500px;
            padding: 0.75rem;
            border: 1px solid rgba(35, 35, 35, 0.2);
            background: var(--background-color);
            color: var(--text-color);
            font-family: var(--font-text);
            font-size: var(--base-font-size);
            resize: none;
        }

        .form-group textarea {
            height: 120px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--link-color);
        }

        /* Button styling with theme colors */
        .btn {
            background: var(--link-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-family: var(--font-text);
            font-size: var(--base-font-size);
            transition: opacity 0.2s ease;
            margin-right: 0.75rem;
            margin-bottom: 0.75rem;
            display: inline-block;
        }

        .btn:hover {
            opacity: var(--link-hover-opacity);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.danger {
            background: #cc3300;
        }

        .btn.success {
            background: #2a664d;
        }

        .btn.small {
            padding: 0.5rem 1rem;
            font-size: calc(var(--base-font-size) * 0.85);
        }

        /* Status badges */
        .key-status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            font-size: calc(var(--base-font-size) * 0.75);
            font-family: var(--font-text);
            font-weight: bold;
        }

        .key-status-badge.active {
            background: rgba(42, 102, 77, 0.2);
            color: #2a664d;
        }

        .key-status-badge.inactive {
            background: rgba(204, 51, 0, 0.2);
            color: #cc3300;
        }

        /* Status messages */
        .status-message {
            padding: 1rem;
            margin: 1.5rem 0;
            font-family: var(--font-text);
            font-size: var(--base-font-size);
            display: none;
        }

        .status-message.show {
            display: block;
        }

        .status-message.error {
            background: rgba(204, 51, 0, 0.1);
            color: #cc3300;
            border-left: 4px solid #cc3300;
        }

        .status-message.success {
            background: rgba(42, 102, 77, 0.1);
            color: #2a664d;
            border-left: 4px solid #2a664d;
        }

        .status-message.info {
            background: rgba(51, 102, 153, 0.1);
            color: #336699;
            border-left: 4px solid #336699;
        }

        /* Instruction text */
        .instruction-text {
            font-family: var(--font-text);
            font-size: var(--base-font-size);
            opacity: 0.8;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(35, 35, 35, 0.05);
            border-left: 3px solid var(--link-color);
        }

        /* Key actions alignment */
        .key-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--background-color);
            color: var(--text-color);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            font-family: var(--font-text);
        }

        .modal-content h3 {
            font-family: var(--font-headline);
            margin-top: 0;
        }

        /* Dark mode support */
        [data-theme="dark"] .form-group input,
        [data-theme="dark"] .form-group textarea,
        [data-theme="dark"] .form-group select {
            background: rgba(35, 35, 35, 0.9);
            border-color: rgba(248, 245, 240, 0.2);
            color: var(--text-color);
        }

        [data-theme="dark"] .section {
            border-color: rgba(248, 245, 240, 0.1);
        }

        [data-theme="dark"] .key-table th,
        [data-theme="dark"] .key-table td {
            border-color: rgba(248, 245, 240, 0.1);
        }

        [data-theme="dark"] .instruction-text {
            background: rgba(248, 245, 240, 0.05);
        }

        /* Layout improvements */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 1.5rem 0;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .key-actions {
                flex-direction: column;
            }
            
            .key-actions .btn {
                margin-right: 0;
            }
        }

        /* Remove extra styling that conflicts with theme */
        .backup-display {
            font-family: var(--font-code);
            font-size: calc(var(--base-font-size) * 0.85);
            background: var(--code-bg);
            color: var(--code-color);
            padding: 1rem;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <header class="site-header">
        <a href="/" class="site-title">Deadline</a>
        <nav class="main-nav">
            <a href="index.html" class="nav-link">User Mode</a>
            <button class="btn danger small" onclick="logoutAdmin()" id="logoutBtn" style="margin-right: 1rem; display: none;">Logout</button>
            <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                <div class="toggle-icons">
                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M12 3v1m0 16v1m-9-9H3m18 0h-1M5.6 5.6l.7.7m12.1-.7l-.7.7M12 18.9a7 7 0 110-14 7 7 0 010 14z"/>
                    </svg>
                    <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                    </svg>
                </div>
                <div class="toggle-circle"></div>
            </button>
        </nav>
    </header>
    
    <div class="container">
        <main class="main">
            <div class="vault-container">
                <h1>Goldeneye Admin Panel</h1>
                <p class="subtitle">Multi-key management system with N-choose-2 security</p>

                <div class="status-message" id="statusMessage"></div>

                <!-- Navigation Tabs -->
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showTab('keys')">Key Management</button>
                    <button class="nav-tab" onclick="showTab('data')">Data Operations</button>
                    <button class="nav-tab" onclick="showTab('security')">Security Settings</button>
                    <button class="nav-tab" onclick="showTab('backup')">Backup & Export</button>
                </div>

                <!-- Key Management Tab -->
                <div id="keysTab" class="tab-content active">
                    <div class="section">
                        <h2>Enrolled Keys</h2>
                        <div class="instruction-text">
                            Manage your enrolled YubiKeys. Any two active keys can decrypt stored data.
                        </div>
                        
                        <table class="key-table" id="keyTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Credential ID</th>
                                    <th>Enrolled</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="keyTableBody">
                                <!-- Dynamic content will be inserted here -->
                            </tbody>
                        </table>

                        <div style="margin-top: 2rem;">
                            <button class="btn success" onclick="showEnrollModal()">Enroll New Key</button>
                            <button class="btn" onclick="refreshKeyList()">Refresh List</button>
                        </div>
                    </div>
                </div>

                <!-- Data Operations Tab -->
                <div id="dataTab" class="tab-content">
                    <div class="section">
                        <h2>Secure Data Storage</h2>
                        
                        <div class="section">
                            <h3>Store New Data</h3>
                            <div class="instruction-text">
                                Enter sensitive data to encrypt. The system will use your enrolled keys to create a secure vault.
                            </div>
                            
                            <div class="form-group">
                                <label for="dataInput">Sensitive Data:</label>
                                <textarea id="dataInput" placeholder="Enter your master password or other sensitive data..."></textarea>
                            </div>
                            
                            <button class="btn success" onclick="encryptAndStore()">Encrypt & Store</button>
                        </div>

                        <div class="section">
                            <h3>Retrieve Data</h3>
                            <div class="instruction-text">
                                Select any two enrolled keys to decrypt stored data.
                            </div>
                            
                            <div class="two-column">
                                <div class="form-group">
                                    <label for="key1Select">First Key:</label>
                                    <select id="key1Select">
                                        <option value="">Select first key...</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="key2Select">Second Key:</label>
                                    <select id="key2Select">
                                        <option value="">Select second key...</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button class="btn" onclick="retrieveData()">Authenticate & Decrypt</button>
                            
                            <div id="decryptedData" style="display: none; margin-top: 2rem; padding: 1.5rem; background: rgba(42, 102, 77, 0.1); border-left: 4px solid #2a664d;">
                                <h3>Decrypted Data:</h3>
                                <div id="decryptedContent" style="margin-top: 1rem; font-family: var(--font-code); word-break: break-all; background: var(--code-bg); padding: 1rem; color: var(--code-color);"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Settings Tab -->
                <div id="securityTab" class="tab-content">
                    <div class="section">
                        <h2>Two-Factor Authentication</h2>
                        <div class="instruction-text">
                            Add an extra layer of security with Time-based One-Time Passwords (TOTP) using apps like Google Authenticator, Authy, or 1Password.
                        </div>
                        
                        <div class="section">
                            <h3>Setup Two-Factor Authentication</h3>
                            
                            <div id="qr-status" class="status-message">✓ QR Code system ready</div>
                            
                            <div style="text-align: center; margin: 1.5rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                                <h4>Scan QR Code</h4>
                                <div id="qr-code-display">
                                    <!-- QR code will be generated here -->
                                </div>
                            </div>
                            
                            <div style="background: #e6f3ff; padding: 1rem; border-radius: 8px; margin: 1rem 0; border-left: 4px solid #0066cc;">
                                <h4>Manual Entry Required</h4>
                                <p><strong>Secret:</strong> <span style="font-family: monospace; background: #f0f0f0; padding: 0.25rem 0.5rem; border-radius: 4px;" id="totp-secret">BQH7PDKXYLNATC5G13PVYMX7RAL4L7ME</span></p>
                                <p><small id="manual-entry-note">QR Code library not loaded. Please enter the secret manually in your authenticator app.</small></p>
                            </div>
                            
                            <div>
                                <h4>Instructions:</h4>
                                <div style="margin: 0.5rem 0;">1. <strong>Scan the QR code above with your authenticator app</strong></div>
                                <div style="margin: 0.5rem 0;">2. <strong>Or manually enter this secret:</strong> <code>BQH7PDKXYLNATC5G13PVYMX7RAL4L7ME</code></div>
                                <div style="margin: 0.5rem 0;">3. <strong>Enter the 6-digit code from your app below to verify</strong></div>
                            </div>
                            
                            <div style="margin-top: 2rem;">
                                <input type="text" id="totp-verify" placeholder="Enter 6-digit code" maxlength="6" style="padding: 0.5rem; margin-right: 1rem; font-size: 1.2rem; text-align: center; width: 150px;">
                                <button class="btn success" onclick="verifyTOTP()">Verify Code</button>
                            </div>
                            
                            <div id="verify-result" class="status-message"></div>
                        </div>
                    </div>
                </div>

                <!-- Backup & Export Tab -->
                <div id="backupTab" class="tab-content">
                    <div class="section">
                        <h2>Backup & Export</h2>
                        
                        <div class="section">
                            <h3>Create Backup</h3>
                            <div class="instruction-text">
                                Export encrypted data and key registry for inheritance scenarios.
                            </div>
                            <button class="btn" onclick="createBackup()">Create Backup File</button>
                            <button class="btn success" onclick="uploadBackup()">Upload to Server</button>
                        </div>

                        <div class="section">
                            <h3>Import Backup</h3>
                            <div class="form-group">
                                <label for="backupFile">Select Backup File:</label>
                                <input type="file" id="backupFile" accept=".json">
                            </div>
                            <button class="btn" onclick="importBackup()">Import from File</button>
                            
                            <div style="margin-top: 2rem;">
                                <div class="form-group">
                                    <label for="backupId">Backup ID from Server:</label>
                                    <input type="text" id="backupId" placeholder="Enter backup ID..." style="max-width: 300px;">
                                </div>
                                <button class="btn" onclick="downloadBackup()">Download from Server</button>
                            </div>
                        </div>

                        <div class="section">
                            <h3>System Reset</h3>
                            <div class="instruction-text" style="color: #cc3300; border-color: #cc3300;">
                                <strong>WARNING:</strong> This will permanently delete all keys and encrypted data.
                            </div>
                            <button class="btn danger" onclick="resetSystem()">Reset All Data</button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Enroll Key Modal -->
    <div id="enrollModal" class="modal">
        <div class="modal-content">
            <h3>Enroll New YubiKey</h3>
            <div class="form-group">
                <label for="keyName">Key Name:</label>
                <input type="text" id="keyName" placeholder="e.g., Diego's Primary Key">
            </div>
            <div class="form-group">
                <label for="keyDescription">Description (optional):</label>
                <textarea id="keyDescription" rows="2" placeholder="Additional notes about this key..."></textarea>
            </div>
            <div style="margin-top: 2rem;">
                <button class="btn success" onclick="enrollNewKey()">Enroll Key</button>
                <button class="btn" onclick="hideEnrollModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- QR Code Library -->
    <script src="qrcode.min.js"></script>
    <script src="admin-auth.js"></script>
    <script src="goldeneye-admin.js"></script>
    
    <script>
        // Initialize authentication system
        window.addEventListener('load', () => {
            adminAuth.initAdminAuth();
        });
        
        // TOTP Setup and QR Code Generation
        function generateTOTPSetup() {
            const secret = 'BQH7PDKXYLNATC5G13PVYMX7RAL4L7ME';
            const issuer = 'Goldeneye';
            const accountName = 'Admin';
            
            // Create TOTP URL
            const totpUrl = `otpauth://totp/${encodeURIComponent(issuer)}:${encodeURIComponent(accountName)}?secret=${secret}&issuer=${encodeURIComponent(issuer)}`;
            
            console.log('TOTP URL:', totpUrl);
            
            // Check if QR library is available
            if (typeof qrcode !== 'undefined') {
                try {
                    const qr = qrcode(0, 'M');
                    qr.addData(totpUrl);
                    qr.make();
                    
                    document.getElementById('qr-code-display').innerHTML = qr.createImgTag(6, 8);
                    document.getElementById('qr-status').textContent = '✓ QR Code generated successfully';
                    document.getElementById('qr-status').className = 'status-message show success';
                    
                    // Hide manual entry notice since QR code worked
                    document.getElementById('manual-entry-note').style.display = 'none';
                    
                    console.log('QR code generated successfully');
                } catch (error) {
                    console.error('QR generation failed:', error);
                    document.getElementById('qr-status').textContent = '✗ QR Code generation failed: ' + error.message;
                    document.getElementById('qr-status').className = 'status-message show error';
                    showManualEntryFallback();
                }
            } else {
                console.log('QR library not available, showing manual entry only');
                showManualEntryFallback();
            }
        }
        
        function showManualEntryFallback() {
            document.getElementById('qr-code-display').innerHTML = '<p style="color: #666;">QR code library not loaded. Use manual entry below.</p>';
            document.getElementById('qr-status').textContent = 'ⓘ QR Code library not loaded. Please enter the secret manually in your authenticator app.';
            document.getElementById('qr-status').className = 'status-message show info';
        }
        
        // TOTP verification function
        function verifyTOTP() {
            const code = document.getElementById('totp-verify').value;
            const resultDiv = document.getElementById('verify-result');
            
            if (code.length !== 6) {
                resultDiv.textContent = 'Please enter a 6-digit code';
                resultDiv.className = 'status-message show error';
                return;
            }
            
            if (!/^\d{6}$/.test(code)) {
                resultDiv.textContent = 'Code must contain only digits';
                resultDiv.className = 'status-message show error';
                return;
            }
            
            // In a real implementation, this would verify against the TOTP algorithm
            // For demo purposes, we'll show success
            resultDiv.innerHTML = `
                <strong>✓ TOTP Setup Complete!</strong><br>
                Code "${code}" received. Two-factor authentication is now configured.
                <br><small>Note: This is a demo. In production, this would verify against the actual TOTP algorithm.</small>
            `;
            resultDiv.className = 'status-message show success';
            
            console.log('TOTP verification attempted with code:', code);
        }
        
        // Enhanced tab switching to handle TOTP setup
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active state from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Initialize TOTP setup when switching to security tab
            if (tabName === 'security') {
                setTimeout(generateTOTPSetup, 500);
            } else if (tabName === 'keys') {
                if (typeof refreshKeyList === 'function') refreshKeyList();
            } else if (tabName === 'data') {
                if (typeof populateKeySelectors === 'function') populateKeySelectors();
            }
        }
        
        // Allow Enter key to verify TOTP
        document.addEventListener('DOMContentLoaded', function() {
            const totpInput = document.getElementById('totp-verify');
            if (totpInput) {
                totpInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        verifyTOTP();
                    }
                });
            }
        });
    </script>
</body>
</html>