<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goldeneye - Secure Inheritance Vault</title>
    <link rel="stylesheet" href="https://iaconelli.org/css/bundle.min.css">
    <script>
        // Theme toggle functionality - inlined from Hugo
        document.addEventListener("DOMContentLoaded", () => {
            initTheme();

            const themeToggle = document.getElementById("theme-toggle");
            if (themeToggle) {
                themeToggle.setAttribute("aria-pressed", "false");
                themeToggle.addEventListener("click", toggleTheme);
            }
        });

        function initTheme() {
            const savedTheme = localStorage.getItem("theme");
            const prefersDark = window.matchMedia(
                "(prefers-color-scheme: dark)",
            ).matches;

            let theme = "light";
            if (savedTheme) {
                theme = savedTheme;
            } else if (prefersDark) {
                theme = "dark";
            }

            setTheme(theme);
        }

        function toggleTheme() {
            const currentTheme =
                document.documentElement.getAttribute("data-theme") || "light";
            const newTheme = currentTheme === "dark" ? "light" : "dark";
            setTheme(newTheme);
        }

        function setTheme(theme) {
            document.documentElement.setAttribute("data-theme", theme);
            localStorage.setItem("theme", theme);

            const toggle = document.getElementById("theme-toggle");
            if (toggle) {
                toggle.setAttribute(
                    "aria-pressed",
                    theme === "dark" ? "true" : "false",
                );
                toggle.setAttribute(
                    "aria-label",
                    theme === "dark"
                        ? "Switch to light mode"
                        : "Switch to dark mode",
                );
            }
        }
    </script>
    <style>
        /* Goldeneye-specific styles - leverages Deadline CSS variables */
        .vault-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            border: 1px solid rgba(35, 35, 35, 0.1);
        }

        /* Dark mode support using Deadline's CSS variables */
        [data-theme="dark"] .vault-container {
            background: rgba(35, 35, 35, 0.8);
            border-color: rgba(248, 245, 240, 0.1);
        }

        [data-theme="dark"] .key-card {
            background: rgba(35, 35, 35, 0.9);
            border-color: rgba(248, 245, 240, 0.1);
        }

        [data-theme="dark"] .section {
            background: rgba(31, 31, 31, 0.5);
            border-color: rgba(248, 245, 240, 0.05);
        }

        [data-theme="dark"] textarea {
            background: rgba(35, 35, 35, 0.9);
            border-color: rgba(248, 245, 240, 0.2);
            color: var(--text-color);
        }

        .subtitle {
            margin-bottom: 2rem;
            opacity: 0.8;
        }

        .section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: rgba(248, 245, 240, 0.5);
            border-radius: 6px;
            border: 1px solid rgba(35, 35, 35, 0.05);
        }

        .key-status {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .key-card {
            flex: 1;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 4px;
            border: 1px solid rgba(35, 35, 35, 0.1);
            transition: all 0.2s ease;
        }

        .key-card.enrolled {
            border-color: #2a664d;
            background: rgba(42, 102, 77, 0.05);
        }

        .key-card.authenticating {
            border-color: #ff7900;
            background: rgba(255, 121, 0, 0.05);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .key-id {
            font-family: monospace;
            font-size: 0.875rem;
            opacity: 0.7;
            word-break: break-all;
        }

        .btn {
            background: #ff7900;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: opacity 0.2s ease;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            display: inline-block;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.danger {
            background: #cc3300;
        }

        .btn.success {
            background: #2a664d;
        }

        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(35, 35, 35, 0.2);
            border-radius: 4px;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 100px;
            font-family: monospace;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.9);
        }

        textarea:focus {
            outline: none;
            border-color: #ff7900;
        }

        .status-message {
            padding: 0.75rem;
            border-radius: 4px;
            margin: 1rem 0;
            font-size: 0.9rem;
            display: none;
        }

        .status-message.show {
            display: block;
        }

        .status-message.error {
            background: rgba(204, 51, 0, 0.1);
            color: #cc3300;
            border: 1px solid rgba(204, 51, 0, 0.2);
        }

        .status-message.success {
            background: rgba(42, 102, 77, 0.1);
            color: #2a664d;
            border: 1px solid rgba(42, 102, 77, 0.2);
        }

        .status-message.info {
            background: rgba(51, 102, 153, 0.1);
            color: #336699;
            border: 1px solid rgba(51, 102, 153, 0.2);
        }

        .instruction-text {
            opacity: 0.8;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(248, 245, 240, 0.8);
            border-radius: 4px;
        }

        .data-display {
            padding: 1rem;
            background: rgba(42, 102, 77, 0.1);
            border: 1px solid rgba(42, 102, 77, 0.2);
            border-radius: 4px;
            margin-top: 1rem;
            font-family: monospace;
            word-break: break-all;
        }

        #enrollmentSection, #dataSection {
            display: none;
        }

        #enrollmentSection.active, #dataSection.active {
            display: block;
        }
    </style>
</head>
<body>
    <header class="site-header">
        <a href="https://iaconelli.org/" class="site-title">Deadline</a>
        <nav class="main-nav">
            <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                <div class="toggle-icons">
                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M12 3v1m0 16v1m-9-9H3m18 0h-1M5.6 5.6l.7.7m12.1-.7l-.7.7M12 18.9a7 7 0 110-14 7 7 0 010 14z"/>
                    </svg>
                    <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                    </svg>
                </div>
                <div class="toggle-circle"></div>
            </button>
        </nav>
    </header>
    
    <div class="container">
        <main class="main">
            <div class="vault-container">
        <h1>Goldeneye Inheritance Vault</h1>
        <p class="subtitle">Insert any two enrolled YubiKeys to access secure data</p>

        <div class="status-message" id="statusMessage"></div>

        <!-- Key Status Display -->
        <div class="key-status">
            <div class="key-card" id="key1Card">
                <h3>✗ First Key</h3>
                <div class="key-id" id="key1Id">Insert and touch YubiKey</div>
            </div>
            <div class="key-card" id="key2Card">
                <h3>✗ Second Key</h3>
                <div class="key-id" id="key2Id">Insert and touch YubiKey</div>
            </div>
        </div>

        <!-- Authentication Section -->
        <div class="section" id="authenticationSection">
            <h2>Access Secure Data</h2>
            <p class="instruction-text">
                To access the secure data, both YubiKeys must be inserted and authenticated. Touch each key when it blinks.
            </p>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <button class="btn" id="auth1Btn" onclick="authenticateKey(1)">Authenticate First Key</button>
                <button class="btn" id="auth2Btn" onclick="authenticateKey(2)">Authenticate Second Key</button>
            </div>
            <button class="btn success" id="unlockBtn" onclick="unlockVault()" disabled>Unlock Vault</button>
        </div>

        <!-- Data Display Section -->
        <div class="section" id="dataSection" style="display: none;">
            <h2>Retrieved Data</h2>
            <div id="decryptedData" class="data-display">
                <strong>Secure Data:</strong>
                <div id="decryptedContent" style="margin-top: 10px; font-family: monospace; word-break: break-all;"></div>
            </div>
            <p style="margin-top: 1rem; opacity: 0.7; font-size: 0.9rem;">This data will be hidden automatically after 2 minutes for security.</p>
        </div>
        
        <!-- Admin Access -->
        <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(35, 35, 35, 0.1);">
            <a href="https://iaconelli.org/admin/" style="color: inherit; opacity: 0.6; text-decoration: none; font-size: 0.8rem;">Admin Panel</a>
        </div>

        <div class="progress-bar" id="progressBar" style="display: none;">
            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
        </div>
    </div>

    <script>
        // Simple user mode - reads from admin data structure
        let authenticatedKeys = new Set();
        let availableKeys = [];
        let selectedKeyPair = { key1: null, key2: null };
        
        // Session timeout management
        let sessionTimer = null;
        const SESSION_TIMEOUT = 120000; // 2 minutes

        // Load available keys from admin data
        function loadAvailableKeys() {
            try {
                const stored = localStorage.getItem('goldeneye_admin_data');
                if (stored) {
                    const data = JSON.parse(stored);
                    const keysMap = new Map(data.keys || []);
                    availableKeys = Array.from(keysMap.values()).filter(k => k.active);
                }
            } catch (error) {
                console.error('Failed to load keys:', error);
                availableKeys = [];
            }
        }

        // Session timeout functions
        function resetSessionTimer() {
            if (sessionTimer) {
                clearTimeout(sessionTimer);
            }
            sessionTimer = setTimeout(expireSession, SESSION_TIMEOUT);
        }

        function expireSession() {
            // Clear authenticated state
            authenticatedKeys.clear();
            selectedKeyPair = { key1: null, key2: null };
            
            // Reset UI
            document.getElementById('key1Card').classList.remove('enrolled');
            document.getElementById('key1Card').querySelector('h3').textContent = '✗ First Key';
            document.getElementById('key1Id').textContent = 'Insert and touch YubiKey';
            
            document.getElementById('key2Card').classList.remove('enrolled');
            document.getElementById('key2Card').querySelector('h3').textContent = '✗ Second Key';
            document.getElementById('key2Id').textContent = 'Insert and touch YubiKey';
            
            document.getElementById('dataSection').style.display = 'none';
            document.getElementById('unlockBtn').disabled = true;
            document.getElementById('auth1Btn').disabled = false;
            document.getElementById('auth2Btn').disabled = false;
            
            showStatus('Session expired - please re-authenticate', 'info');
        }

        // Initialize the application
        function init() {
            loadAvailableKeys();
            resetSessionTimer();
            
            if (availableKeys.length === 0) {
                showStatus('No keys enrolled. Please use Admin Panel to enroll keys first.', 'error');
                return;
            }
            
            showStatus(`Found ${availableKeys.length} enrolled keys. Insert any two YubiKeys to begin.`, 'info');
            
            // Reset timer on any user activity
            document.addEventListener('click', resetSessionTimer);
            document.addEventListener('keypress', resetSessionTimer);
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message show ${type}`;
            
            if (type !== 'error') {
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 5000);
            }
        }

        // Generic error handler to prevent information disclosure
        function handleError(error, operation) {
            console.error(`${operation} error:`, error);
            
            // Map specific errors to generic messages
            if (error.name === 'NotAllowedError') {
                return 'Authentication was cancelled or timed out';
            } else if (error.name === 'SecurityError') {
                return 'Security requirements not met (HTTPS required)';
            } else if (error.name === 'NotSupportedError') {
                return 'WebAuthn not supported by this browser or device';
            } else {
                return `${operation} failed. Please try again`;
            }
        }

        // Generate challenge for WebAuthn
        function generateChallenge() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return array;
        }

        // Convert ArrayBuffer to Base64
        function bufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        // Convert Base64 to ArrayBuffer
        function base64ToBuffer(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Authenticate a YubiKey (detects which enrolled key is inserted)
        async function authenticateKey(keyNumber) {
            if (selectedKeyPair.key1 && selectedKeyPair.key2) {
                showStatus('Both keys already authenticated', 'info');
                return;
            }
            
            try {
                showStatus(`Insert and touch YubiKey ${keyNumber}...`, 'info');
                document.getElementById(`key${keyNumber}Card`).classList.add('authenticating');
                document.getElementById(`auth${keyNumber}Btn`).disabled = true;

                // Try to authenticate against all enrolled keys
                let matchedKey = null;
                let authResult = null;
                
                for (const key of availableKeys) {
                    try {
                        const challenge = generateChallenge();
                        const credentialId = base64ToBuffer(key.credentialId);

                        const assertion = await navigator.credentials.get({
                            publicKey: {
                                challenge: challenge,
                                allowCredentials: [{
                                    id: credentialId,
                                    type: 'public-key',
                                    transports: ['usb', 'nfc']
                                }],
                                userVerification: "discouraged",
                                timeout: 60000
                            }
                        });

                        // Found a matching key
                        matchedKey = key;
                        authResult = bufferToBase64(assertion.response.signature);
                        break;
                    } catch (e) {
                        // Try next key
                        continue;
                    }
                }

                if (!matchedKey) {
                    throw new Error('No matching enrolled key found');
                }

                // Check if this key is already authenticated
                if (authenticatedKeys.has(matchedKey.id)) {
                    throw new Error('This key is already authenticated. Please use a different key.');
                }

                // Store authentication
                authenticatedKeys.add(matchedKey.id);
                if (keyNumber === 1) {
                    selectedKeyPair.key1 = { key: matchedKey, auth: authResult };
                } else {
                    selectedKeyPair.key2 = { key: matchedKey, auth: authResult };
                }

                // Update UI
                document.getElementById(`key${keyNumber}Card`).classList.remove('authenticating');
                document.getElementById(`key${keyNumber}Card`).classList.add('enrolled');
                document.getElementById(`key${keyNumber}Card`).querySelector('h3').textContent = `✓ ${matchedKey.name}`;
                document.getElementById(`key${keyNumber}Id`).textContent = `ID: ${matchedKey.credentialId.substring(0, 16)}...`;

                showStatus(`Key "${matchedKey.name}" authenticated successfully!`, 'success');

                // Check if both keys are authenticated
                if (selectedKeyPair.key1 && selectedKeyPair.key2) {
                    document.getElementById('unlockBtn').disabled = false;
                    showStatus('Both keys authenticated! Click "Unlock Vault" to access data.', 'success');
                }

            } catch (error) {
                document.getElementById(`key${keyNumber}Card`).classList.remove('authenticating');
                document.getElementById(`auth${keyNumber}Btn`).disabled = false;
                const errorMessage = handleError(error, 'Key authentication');
                showStatus(errorMessage, 'error');
            }
        }

        // Derive encryption key using N-choose-2 system
        async function deriveEncryptionKey(keyData1, keyData2, salt) {
            // Create deterministic key material by sorting credential IDs
            const sortedCredentials = [keyData1.key.credentialId, keyData2.key.credentialId].sort();
            const combined = sortedCredentials.join('') + salt;
            
            const encoder = new TextEncoder();
            const data = encoder.encode(combined);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            
            return crypto.subtle.importKey(
                'raw',
                hashBuffer,
                { name: 'AES-GCM' },
                false,
                ['encrypt', 'decrypt']
            );
        }

        // Unlock vault with authenticated keys
        async function unlockVault() {
            if (!selectedKeyPair.key1 || !selectedKeyPair.key2) {
                showStatus('Both keys must be authenticated first', 'error');
                return;
            }

            try {
                showStatus('Accessing vault data...', 'info');
                
                // Load vault data from admin storage
                const stored = localStorage.getItem('goldeneye_admin_data');
                if (!stored) {
                    showStatus('No vault data found', 'error');
                    return;
                }
                
                const adminData = JSON.parse(stored);
                const vaultsMap = new Map(adminData.vaults || []);
                
                if (vaultsMap.size === 0) {
                    showStatus('No encrypted data found in vault', 'error');
                    return;
                }

                // Find a vault that can be decrypted with these keys
                const keyIds = [selectedKeyPair.key1.key.id, selectedKeyPair.key2.key.id];
                let vault = null;
                
                for (const vaultData of vaultsMap.values()) {
                    for (const keyPair of vaultData.keyPairs) {
                        if ((keyPair.includes(keyIds[0]) && keyPair.includes(keyIds[1]))) {
                            vault = vaultData;
                            break;
                        }
                    }
                    if (vault) break;
                }

                if (!vault) {
                    showStatus('No data found that can be decrypted with these keys', 'error');
                    return;
                }

                // Derive decryption key using stored salt
                const decryptionKey = await deriveEncryptionKey(selectedKeyPair.key1, selectedKeyPair.key2, vault.salt);

                // Decrypt the data
                const encryptedBuffer = base64ToBuffer(vault.encryptedData);
                const iv = base64ToBuffer(vault.iv);

                const decryptedData = await crypto.subtle.decrypt(
                    {
                        name: 'AES-GCM',
                        iv: iv
                    },
                    decryptionKey,
                    encryptedBuffer
                );

                const decoder = new TextDecoder();
                const decryptedText = decoder.decode(decryptedData);

                // Display decrypted data
                document.getElementById('decryptedContent').textContent = decryptedText;
                document.getElementById('dataSection').style.display = 'block';
                
                showStatus('Vault unlocked successfully!', 'success');

                // Auto-hide decrypted data after 2 minutes for security
                setTimeout(() => {
                    document.getElementById('dataSection').style.display = 'none';
                    document.getElementById('decryptedContent').textContent = '';
                    showStatus('Data hidden automatically for security', 'info');
                }, 120000);

            } catch (error) {
                const errorMessage = handleError(error, 'Vault unlock');
                showStatus(errorMessage, 'error');
            }
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
            </div>
        </main>
    </div>
</body>
</html>